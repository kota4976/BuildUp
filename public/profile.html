<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロフィール - BuildUp</title>
    <!-- 外部CSSの参照（変更なし） -->
    <link rel="stylesheet" href="styles/profile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

<!-- HTML構造は一切変更なし -->
<build-up-header></build-up-header>

<script src="component/header-component.js" type="module"></script>

<div class="main-content">

    <div class="profile-card">
        <img src="images/profile_placeholder.jpg" alt="プロフィール画像" class="profile-img" id="profile-avatar">

        <div class="profile-info" id="profile-info-container">
            <h1 id="profile-name">読み込み中...</h1>
            <p id="profile-bio"></p>
        </div>

        <button class="edit-btn" id="edit-profile-btn">✍️ Edit Profile</button>
    </div>

    <div class="tabs">
        <a href="#" class="active">Overview</a>
        <a href="#">Projects</a>
        <a href="#">Skills</a>
        <a href="#">Achievements</a>
    </div>

    <div class="profile-layout">

        <div class="left-column">

            <div id="overview-content" class="tab-content active">
                <div class="section-card about-section">
                    <h3>About</h3>
                    <p id="profile-about-text"></p>
                </div>
            </div>

            <div id="projects-content" class="tab-content hidden">
                <div class="project-list" id="profile-projects-list">
                </div>
            </div>
        </div>

        <div class="right-column">
            <div class="section-card contact-info" id="profile-contact-info">
                <h3>Contact Information</h3>
                <div class="info-item" id="contact-email"></div>
                <div class="info-item" id="contact-github"></div>
            </div>

            <div class="section-card quick-stats" id="profile-stats">
                <h3>Quick Stats</h3>
            </div>
        </div>
    </div>
</div>

<script src="scripts/tab_switcher.js" defer></script>


<script>
    // --- API呼び出しの設定 ---
    const API_BASE_URL = 'http://localhost:8080/api/v1';

    // (既存の `const token = ...` は削除)

    // --- APIを呼び出す関数 (変更なし) ---
    async function fetchMyInfo(tokenToUse) {

        const endpoint = `${API_BASE_URL}/auth/me`;
        console.log("リクエストを送信中...", endpoint);

        try {
            const response = await fetch(endpoint, {
                method: 'GET',
                headers: {
                    // 渡されたトークンを使用
                    'Authorization': `Bearer ${tokenToUse}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const userData = await response.json();
                console.log("✅ 認証成功！ ユーザー情報:", userData);

                // --- 取得した情報をHTMLに反映させる (IDが存在するので成功する) ---
                if (document.getElementById('profile-name')) {
                    document.getElementById('profile-name').textContent = userData.handle;
                }
                if (document.getElementById('profile-bio')) {
                    document.getElementById('profile-bio').textContent = userData.bio || "自己紹介が設定されていません"; // bioがnullの場合の対策
                }
                if (document.getElementById('profile-about-text')) {
                    document.getElementById('profile-about-text').textContent = userData.bio || "自己紹介が設定されていません";
                }
                if (document.getElementById('contact-email')) {
                    // Font Awesomeのアイコンも動的に追加
                    document.getElementById('contact-email').innerHTML = `<i class="fa-solid fa-envelope"></i> ${userData.email || 'メール未設定'}`;
                }
                if (document.getElementById('contact-github')) {
                    document.getElementById('contact-github').innerHTML = `<i class="fa-brands fa-github"></i> <a href="https://github.com/${userData.github_login}" target="_blank" rel="noopener noreferrer">/${userData.github_login}</a>`;
                }
                if (document.getElementById('profile-avatar')) {
                    document.getElementById('profile-avatar').src = userData.avatar_url;
                }

            } else {
                // トークンが無効だった場合 (例: 有効期限切れ)
                const errorData = await response.json();
                console.error(
                    `❌ 認証失敗 (ステータス: ${response.status})`,
                    errorData
                );
                // ログインページに戻す
                localStorage.removeItem('accessToken'); // 無効なトークンを削除
                window.location.href = '/public/login.html?error=invalid_token';
            }
        } catch (error) {
            console.error("ネットワークエラーが発生しました:", error);
        }
    }

    // --- 実行ロジック (★★★ ここが変更点 ★★★) ---

    // 1. URLハッシュからトークンを読み取る試み
    function getTokenFromHash() {
        // window.location.hash は "#access_token=..." のような文字列を返す
        const hash = window.location.hash.substring(1); // 先頭の # を削除
        const params = new URLSearchParams(hash);
        return params.get('access_token');
    }

    let token = getTokenFromHash();

    if (token) {
        // 1a. ハッシュにトークンが見つかった場合 (OAuthリダイレクト直後)
        console.log("URLハッシュからトークンを取得しました。");
        // トークンをlocalStorageに保存
        localStorage.setItem('accessToken', token);
        // URLからハッシュを削除してクリーンにする
        window.history.replaceState({}, document.title, window.location.pathname + window.location.search);

        // トークンを使ってプロフィール情報を取得
        fetchMyInfo(token);

    } else {
        // 1b. ハッシュにトークンがない場合、localStorageを確認 (通常の訪問)
        console.log("URLハッシュにトークンなし。localStorageを確認します。");
        token = localStorage.getItem('accessToken');

        if (token) {
            // トークンがlocalStorageに存在する場合、プロフィール情報を取得
            fetchMyInfo(token);
        } else {
            // トークンがどこにも存在しない（未ログイン）場合
            console.log("トークンが見つかりません。ログインページにリダイレクトします。");
            // ログインページにリダイレクト
            window.location.href = '/public/login.html';
        }
    }
</script>
</body>
</html>